<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>使用Kickstart全自动化安装CentOS 5.x系统</title><meta name="author" content="LazyZhu"/><meta name="keywords" content="linux,centos,kickstart,script,automate"/><meta name="description" content="Kickstart基于Anaconda程序，可用来全自动化部署安装RedHat系列系统，包括CentOS，本文将介绍如何使用Kickstart安装CentOS5.x系统。"/><link rel="stylesheet" type="text/css" href="/assets/css/main.css"/><link rel="stylesheet" type="text/css" href="/assets/css/pygments.css"/></head><body><div class="container"><div class="header"><div id="siteName"> L<u>azy</u>Z<u>hu's</u> H<u>ome</u> <b><font color="red">★The Diaoyu Islands belong to China!★</font></b></div><ul class="menu main"><li class="menu_item"> <a href="/">Home</a></li><li class="menu_item"> <a href="/projects.html">Projects</a></li><li class="menu_item"> <a href="/wiki.html">Wiki</a></li><li class="menu_item"> <a href="/about.html">About</a></li></ul></div><div class="sidebar"><div><center><form id="cse" id="searchbox_005189583365303993202:tnnrmg1lhbi" action="/SearchResults.html"> <input value="005189583365303993202:dwmyxdrq_ny" name="cx" type="hidden"/> <input value="FORID:11" name="cof" type="hidden"/> <input id="q" style="width:110px" name="q" size="75" /> <input value="Search" name="sa" type="submit"/></form></center><h4>分类</h4><ul><li> <a href="/categories.html#Linux"> <b><font color="blue">Linux</font></b> </a> <sup>[3]</sup></li><li> <a href="/categories.html#Nginx"> Nginx </a> <sup>[3]</sup></li><li> <a href="/categories.html#Life"> Life </a> <sup>[1]</sup></li></ul><hr/><h4>标签</h4><ul><li> <a href="/tags.html#script"> <b><font color="blue">script</font></b> </a> <sup>[2]</sup></li><li> <a href="/tags.html#compile"> compile </a> <sup>[2]</sup></li><li> <a href="/tags.html#xshell"> xshell </a> <sup>[2]</sup></li><li> <a href="/tags.html#publickey"> publickey </a> <sup>[1]</sup></li><li> <a href="/tags.html#linux"> <b><font color="blue">linux</font></b> </a> <sup>[3]</sup></li><li> <a href="/tags.html#blog"> blog </a> <sup>[1]</sup></li><li> <a href="/tags.html#module"> module </a> <sup>[2]</sup></li><li> <a href="/tags.html#centos"> <b><font color="blue">centos</font></b> </a> <sup>[1]</sup></li><li> <a href="/tags.html#windows"> windows </a> <sup>[1]</sup></li><li> <a href="/tags.html#nginx"> nginx </a> <sup>[3]</sup></li><li> <a href="/tags.html#memcached"> memcached </a> <sup>[1]</sup></li><li> <a href="/tags.html#static"> static </a> <sup>[1]</sup></li><li> <a href="/tags.html#shell"> shell </a> <sup>[1]</sup></li><li> <a href="/tags.html#ssh"> ssh </a> <sup>[1]</sup></li><li> <a href="/tags.html#gzip"> gzip </a> <sup>[1]</sup></li><li> <a href="/tags.html#redis"> redis </a> <sup>[1]</sup></li><li> <a href="/tags.html#lnmp"> lnmp </a> <sup>[2]</sup></li><li> <a href="/tags.html#automate"> <b><font color="blue">automate</font></b> </a> <sup>[2]</sup></li><li> <a href="/tags.html#putty"> putty </a> <sup>[2]</sup></li><li> <a href="/tags.html#kickstart"> <b><font color="blue">kickstart</font></b> </a> <sup>[1]</sup></li><li> <a href="/tags.html#life"> life </a> <sup>[1]</sup></li></ul><hr/><h4>归档</h4><ul><li><b><font color="blue"><a href="/archive.html#2012">2012</a></font></b></li></ul></div></div><div class="content"><div class="tags"> 分类: /<a class="category" href="/categories.html#Linux">Linux</a>/ - 标签: <span class="tag"><a href="/tags.html#linux">linux</a></span> <span class="tag"><a href="/tags.html#centos">centos</a></span> <span class="tag"><a href="/tags.html#kickstart">kickstart</a></span> <span class="tag"><a href="/tags.html#script">script</a></span> <span class="tag"><a href="/tags.html#automate">automate</a></span> - 日期: 2012.09.07</div><br/><h1>使用Kickstart全自动化安装CentOS 5.x系统</h1><p>全自动化部署安装操作系统十分常见，较为熟知的就是Windows下的Ghost了。相较于传统的手动安装，免于人工参与，省时、省力。在Linux 也有个程序，叫 <code>Anaconda</code>，是由它生成的为 <code>Kickstart</code> (ks.cfg)脚本。通过这样一个脚本，Linux 管理员可以自动快速批量部署CentOS系统。</p><br/><h2>1. Kickstart脚本的创建</h2><p>在CentOS安装完成后，会在<code>root</code>用户的目录中自动生成一个配置文件，名称为<code>anaconda-ks.cfg</code>，这个就是Kickstart的安装脚本了。这个文件包含了当前CentOS系统安装时的配置参数，如果需要配置相同的CentOS系统，完全可以使用它来部署，当然也可以修改其参数已符合其他场合。Kickstart脚本也可以由<code>Anaconda</code>手动创建。<code>Anaconda</code>是<code>RedHat</code>、<code>CentOS</code>、<code>Fedora</code>等Linux的安装管理程序，它可以提供文本、图形等安装管理方式，并支持Kickstart等脚本提供自动安装的功能。运行<code>system-config-kickstat</code>命令可启动Kickstart图形化界面配置。</p><p>利用生成的kickstart配置文件<code>ks.cfg</code>，服务器安装可以实现从裸机到全功能服务的的非交互式（无人值守式）安装配置； <code>ks.cfg</code>是一个文本文件，文件包含Anconda在安装系统及安装后配置服务时所需要获取的一些必要配置信息（如键盘设置，语言设置，分区设置等）；Anconda直接从该文件中读取必要的配置，只要该文件信息配置正确无误且满足所有系统需求，就不再需要同用户进行交互获取信息，从而实现安装的自动化；但是配置中如果忽略任何必需的项目，安装程序会提示用户输入相关的项目的选择，就象用户在典型的安装过程中所遇到的一样。一旦用户进行了选择，安装会以非交互的方式（unattended）继续。</p><br/><h2>2. Kickstart脚本的参数</h2><p>Kickstart脚本的参数主要包括以下11类：</p><ul><li>Basic Configuration（基本设置）</li></ul><blockquote><p>可以设置系统默认语言、键盘、时区以及root密码等。还可以选择安装系统时的界面模式（文本或图形）。</p></blockquote><ul><li>Installation Method（安装方式）</li></ul><blockquote><p>操作系统选择是全新安装还是升级。不推荐使用Kickstart升级操作系统，因为在升级的过程中会出现很多的交互选项，会比较麻烦。还可以指定安装源（如：CD-ROM、NFS、FTP、HTTP或本地磁盘）</p></blockquote><ul><li>Boot Loader Options（启动选项）</li></ul><blockquote><p>修改启动选项的设置，一般使用默认的就可以了。</p></blockquote><ul><li>Partition Information（分区设置）</li></ul><blockquote><p>如果你的服务器上有SAN存储器，需要谨慎操作此选项。在默认情况下，Kickstart脚本会尝试清除SAN存储器中的内容，并将新操作系统安装在上面。</p></blockquote><ul><li>Network Configuration（网络设置）</li></ul><blockquote><p>Kickstart默认不会修改网络接口。因为IP地址每台机子都是唯一的。具体需要怎么做，笔者稍候会作出解答<sup>_<sup>。</sup></sup></p></blockquote><ul><li>Authentication（认证方式）</li></ul><blockquote><p>Kickstart默认使用shadow文件进行密码认证。对于大型系统的部署，可能会用到专用的认证系统。Kickstart支持NIS，LDAP，Kerberos，SMB 和Name Switch Cache。</p></blockquote><ul><li>Firewall Configuration（防火墙设置）</li></ul><blockquote><p>可以设置防火墙和SELinux。如果你不喜欢SELinux直接禁用就可以了。如果是最小化安装，建议禁用防火墙稍候再设置。</p></blockquote><ul><li>Display Configuration（显示设置）</li></ul><blockquote><p>如果是服务器的话，直接text mode就可以了。</p></blockquote><ul><li>Package Selection（安装包选择）</li></ul><blockquote><p>指定CentOS预安装的软件包。</p></blockquote><ul><li>Pre-installation Script（预执行脚本）</li></ul><blockquote><p>可用于获取IP等信息。</p></blockquote><ul><li>Post-installation Script（延迟执行脚本）</li></ul><blockquote><p>定义bash、Perl或Python脚本以供安装脚本使用。</p></blockquote><p>以上内容参考自<a href="http://www.cnphp.info/quick-install-centos-6-0-with-kickstart.html" title="Kickstart">这里</a>，部分内容略作修改。</p><p>至于具体的参数含义请参考<code>Kickstart脚本的实例</code>。</p><br/><h2>3. Kickstart脚本的使用</h2><p>Kickstart的安装可以是本地（光驱、硬盘）或过网络（NFS、FTP 或 HTTP），对于VPS、服务器等推荐使用网络安装的方式，这样效率较高。</p><p>至于ks.cfg文件，可以将之放在网络上，也可以将ks.cfg文件整合到光盘中，或者使用<code>PXE</code>引导进行安装。具体就是：使用光盘引导到启动界面并指定ks.cfg文件。</p><p>其实很简单，在<code>boot:</code>后输入<code>linux ks=url</code></p><p>如果是ks.cfg文件在网络，则</p><div class="highlight"><pre><code class="bash"><span class="nv">ks</span><span class="o">=</span>http://sample.com/kickstart/ks.cfg <span class="c"># http</span>
<span class="nv">ks</span><span class="o">=</span>ftp://8.8.8.8/kickstart//ks.cfg <span class="c"># ftp</span>
<span class="nv">ks</span><span class="o">=</span>nfs:8.8.8.8:/kickstart/ks.cfg <span class="c"># nfs</span>
</code></pre></div><p>如果是ks.cfg文件在本地，则</p><div class="highlight"><pre><code class="bash"><span class="nv">ks</span><span class="o">=</span>cdrom:/ks.cfg <span class="c"># 光盘</span>
<span class="nv">ks</span><span class="o">=</span>hd:/sdb1/ks.cfg <span class="c"># 硬盘</span>
<span class="nv">ks</span><span class="o">=</span>floppy:/ks.cfg <span class="c"># 软盘</span>
</code></pre></div><p>ks.cfg文件也可被打包进initrd根文件系统中</p><div class="highlight"><pre><code class="bash"><span class="nv">ks</span><span class="o">=</span>file:/ks.cfg
</code></pre></div><br/><h2>4. Kickstart脚本的实例</h2><p>写了一个Kickstart脚本，适合于安装<code>CentOS 5.x</code>系统。对一些常规选项进行了自动化处理进行安装，更便于安装和使用，基本上安装好就是一个最优化的系统，极大方便了安装和使用，对于不熟悉或常需安装系统(的朋友来说更是一个便利。装完后的系统进行了更新和优化，且只包含最基本的软件包和服务，是最新、最小的CentOS精简版系统。</p><p>全程安装过程只需5分钟左右，无需人工干预。安装最后还有30秒时间修改SSH端口（可选，但强烈推荐）。</p><p>系统默认密码：<code>LazyZhu</code>，请运行<code>passwd</code>修改。</p><p>将脚本另存为<code>centos.58.x86.v1.5.ks.cfg</code>并存于直链空间，或直接使用下面的：</p><p>在光盘启动界面下面<code>boot:</code>后输入<code>linux ks=http://fzrxefe.googlecode.com/files/centos.58.x86.v1.5.ks.cfg</code>，如图：</p><p><img src="/images/2012/2012-09-07-kickstart.png" alt="Kickstart"/></p><p>此Kickstart脚本默认只支持<code>32位</code>的<code>CentOS 5.x</code>，如果安装<code>64位</code>的<code>CentOS 5.x</code>，则将脚本中链接</p><div class="highlight"><pre><code class="bash">http://mirrors.usc.edu/pub/linux/distributions/centos/5/os/i386
</code></pre></div><p>替换为</p><div class="highlight"><pre><code class="bash">http://mirrors.usc.edu/pub/linux/distributions/centos/5/os/x86_64
</code></pre></div><p>或者直接使用<code>linux ks=http://fzrxefe.googlecode.com/files/centos.58.x64.v1.5.ks.cfg</code>。</p><p>Kickstart脚本如下：</p><div class="highlight"><pre><code class="bash"><span class="c"># CentOS 5.x Minimal Install Scripts</span>
<span class="c"># boot: linux ks=http://fzrxefe.googlecode.com/files/centos.58.x86.v1.5.ks.cfg</span>
<span class="c"># root's password: LazyZhu, Run "passwd" to Change it.</span>
<span class="c"># Basic Configuration</span>
install
lang en_US.UTF-8
keyboard us
timezone --utc Asia/Shanghai
rootpw --iscrypted <span class="nv">$1$M6UtZ5TA$K9BDnMbbXnXLK8qpVOf</span>/i0
<span class="c"># Display Configuration</span>
text
skipx
<span class="c"># Authentication</span>
authconfig --enableshadow --enablemd5
<span class="c"># Installation Method</span>
url --url http://mirrors.usc.edu/pub/linux/distributions/centos/5/os/i386
logging --level<span class="o">=</span>info
reboot
<span class="c"># Boot Loader Options</span>
bootloader --location<span class="o">=</span>mbr
<span class="c"># Partition Information</span>
zerombr
clearpart --all --initlabel
part swap --fstype swap --size<span class="o">=</span>512
part / --fstype ext3 --size<span class="o">=</span>100 --grow
<span class="c"># Network Configuration</span>
network --onboot yes --device eth0 --bootproto dhcp --noipv6 --hostname Minimal
<span class="c"># Firewall Configuration</span>
selinux --disabled
firewall --disabled
<span class="c"># Package Selection</span>
%packages --nobase --ignoremissing
audit-libs
basesystem
bash
binutils
bzip2
bzip2-libs
centos-release
centos-release-notes
chkconfig
coreutils
cpio
cracklib
cracklib-dicts
crontabs
cyrus-sasl-lib
db4
device-mapper
device-mapper-event
device-mapper-multipath
dhclient
diffutils
dmraid
dmraid-events
e2fsprogs
e2fsprogs-libs
elfutils-libelf
ethtool
expat
filesystem
findutils
fipscheck
fipscheck-lib
gawk
gdbm
glib2
glibc
glibc-common
grep
grub
gzip
hmaccalc
info
initscripts
iproute
iputils
iscsi-initiator-utils
kbd
kernel
keyutils-libs
kpartx
krb5-libs
less
libacl
libattr
libcap
libgcc
libselinux
libsepol
libstdc++
libsysfs
libtermcap
libuser
libutempter
libxml2
logrotate
lvm2
m2crypto
MAKEDEV
mcstrans
mingetty
mkinitrd
mktemp
module-init-tools
nano
nash
ncurses
net-tools
nspr
nss
openldap
openssh
openssh-clients
openssh-server
openssl
pam
passwd
pcre
popt
procps
psmisc
python
python-elementtree
python-iniparse
python-libs
python-sqlite
python-urlgrabber
readline
redhat-logos
rootfiles
rpm
rpm-libs
rpm-python
sed
setup
sgpio
shadow-utils
sqlite
sysklogd
SysVinit
tar
tcp_wrappers
termcap
tzdata
udev
usermode
util-linux
vim-minimal
vixie-cron
wget
which
yum
yum-fastestmirror
yum-metadata-parser
zlib
-atk
-audit-libs-python
-authconfig
-binutils
-bitstream-vera-fonts
-cairo
-checkpolicy
-cryptsetup-luks
-cups-libs
-dbus
-dbus-glib
-dbus-libs
-dhcpv6-client
-dmidecode
-ecryptfs-utils
-ed
-file
-fontconfig
-freetype
-gnu-efi
-gnutls
-gtk2
-hal
-hdparm
-hicolor-icon-theme
-hwdata
-keyutils
-kudzu
-libgcrypt
-libgpg-error
-libhugetlbfs
-libjpeg
-libpng
-libselinux-python
-libselinux-utils
-libsemanage
-libtiff
-libusb
-libvolume_id
-libX11
-libXau
-libXcursor
-libXdmcp
-libXext
-libXfixes
-libXft
-libXi
-libXinerama
-libXrandr
-libXrender
-newt
-pango
-pciutils
-pm-utils
-policycoreutils
-prelink
-rsyslog
-selinux-policy
-selinux-policy-targeted
-setools
-setserial
-slang
-sysfsutils
-tcl
-trousers
-udftools
-xorg-x11-filesystem
<span class="c"># Pre-installation Script</span>
<span class="c"># Post-installation Script</span>
%post --log<span class="o">=</span>/root/ks.post.log
<span class="c"># Allow User Interaction In The %post Section</span>
<span class="nb">exec</span> &lt; /dev/tty3 &gt; /dev/tty3
chvt 3
/bin/cat &gt; /root/Minimal.sh <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>
<span class="s"># Set Linux PATH Environment Variables</span>
<span class="s">PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin</span>
<span class="s">export PATH</span>
<span class="s">stty erase '^?'</span>
<span class="s"># Yum Update System</span>
<span class="s">\/bin/cp -Rf /boot/grub/grub.conf /boot/grub/grub.conf.bak</span>
<span class="s">/bin/sed -i '/^.*exclude=.*/d' /etc/yum.conf</span>
<span class="s">/usr/bin/yum update -y</span>
<span class="s"># Remove Unused Old Kernel</span>
<span class="s">/usr/bin/yum remove -y kernel-`/bin/uname -r`</span>
<span class="s"># Yum Clean Cache</span>
<span class="s">/usr/bin/yum clean all</span>
<span class="s">/bin/rm -rf /var/cache/yum/*</span>
<span class="s"># Prevent Future Yum Update Kernel</span>
<span class="s">/bin/echo "exclude=kernel-2.* kernel-debug-2.*" &gt;&gt; /etc/yum.conf</span>
<span class="s"># Remove Unnecessary Services on Boot</span>
<span class="s">/sbin/chkconfig iscsi off</span>
<span class="s">/sbin/chkconfig iscsid off</span>
<span class="s">/sbin/chkconfig lvm2-monitor off</span>
<span class="s">/sbin/chkconfig mcstrans off</span>
<span class="s">/sbin/chkconfig netfs off</span>
<span class="s">/sbin/chkconfig rawdevices off</span>
<span class="s"># Change Default SSH Port</span>
<span class="s">function change_sshport() {</span>
<span class="s">    /bin/echo -e "<code class="bash"><span class="c"># CentOS 5.x Minimal Install Scripts</span>
<span class="c"># boot: linux ks=http://fzrxefe.googlecode.com/files/centos.58.x86.v1.5.ks.cfg</span>
<span class="c"># root&#39;s password: LazyZhu, Run &quot;passwd&quot; to Change it.</span>

<span class="c"># Basic Configuration</span>
install
lang en_US.UTF-8
keyboard us
timezone --utc Asia/Shanghai
rootpw --iscrypted <span class="nv">$1$M6UtZ5TA$K9BDnMbbXnXLK8qpVOf</span>/i0
<span class="c"># Display Configuration</span>
text
skipx
<span class="c"># Authentication</span>
authconfig --enableshadow --enablemd5
<span class="c"># Installation Method</span>
url --url http://mirrors.usc.edu/pub/linux/distributions/centos/5/os/i386
logging --level<span class="o">=</span>info
reboot
<span class="c"># Boot Loader Options</span>
bootloader --location<span class="o">=</span>mbr
<span class="c"># Partition Information</span>
zerombr
clearpart --all --initlabel
part swap --fstype swap --size<span class="o">=</span>512
part / --fstype ext3 --size<span class="o">=</span>100 --grow
<span class="c"># Network Configuration</span>
network --onboot yes --device eth0 --bootproto dhcp --noipv6 --hostname Minimal
<span class="c"># Firewall Configuration</span>
selinux --disabled
firewall --disabled
<span class="c"># Package Selection</span>
%packages --nobase --ignoremissing
audit-libs
basesystem
bash
binutils
bzip2
bzip2-libs
centos-release
centos-release-notes
chkconfig
coreutils
cpio
cracklib
cracklib-dicts
crontabs
cyrus-sasl-lib
db4
device-mapper
device-mapper-event
device-mapper-multipath
dhclient
diffutils
dmraid
dmraid-events
e2fsprogs
e2fsprogs-libs
elfutils-libelf
ethtool
expat
filesystem
findutils
fipscheck
fipscheck-lib
gawk
gdbm
glib2
glibc
glibc-common
grep
grub
gzip
hmaccalc
info
initscripts
iproute
iputils
iscsi-initiator-utils
kbd
kernel
keyutils-libs
kpartx
krb5-libs
less
libacl
libattr
libcap
libgcc
libselinux
libsepol
libstdc++
libsysfs
libtermcap
libuser
libutempter
libxml2
logrotate
lvm2
m2crypto
MAKEDEV
mcstrans
mingetty
mkinitrd
mktemp
module-init-tools
nano
nash
ncurses
net-tools
nspr
nss
openldap
openssh
openssh-clients
openssh-server
openssl
pam
passwd
pcre
popt
procps
psmisc
python
python-elementtree
python-iniparse
python-libs
python-sqlite
python-urlgrabber
readline
redhat-logos
rootfiles
rpm
rpm-libs
rpm-python
sed
setup
sgpio
shadow-utils
sqlite
sysklogd
SysVinit
tar
tcp_wrappers
termcap
tzdata
udev
usermode
util-linux
vim-minimal
vixie-cron
wget
which
yum
yum-fastestmirror
yum-metadata-parser
zlib
-atk
-audit-libs-python
-authconfig
-binutils
-bitstream-vera-fonts
-cairo
-checkpolicy
-cryptsetup-luks
-cups-libs
-dbus
-dbus-glib
-dbus-libs
-dhcpv6-client
-dmidecode
-ecryptfs-utils
-ed
-file
-fontconfig
-freetype
-gnu-efi
-gnutls
-gtk2
-hal
-hdparm
-hicolor-icon-theme
-hwdata
-keyutils
-kudzu
-libgcrypt
-libgpg-error
-libhugetlbfs
-libjpeg
-libpng
-libselinux-python
-libselinux-utils
-libsemanage
-libtiff
-libusb
-libvolume_id
-libX11
-libXau
-libXcursor
-libXdmcp
-libXext
-libXfixes
-libXft
-libXi
-libXinerama
-libXrandr
-libXrender
-newt
-pango
-pciutils
-pm-utils
-policycoreutils
-prelink
-rsyslog
-selinux-policy
-selinux-policy-targeted
-setools
-setserial
-slang
-sysfsutils
-tcl
-trousers
-udftools
-xorg-x11-filesystem

<span class="c"># Pre-installation Script</span>

<span class="c"># Post-installation Script</span>
%post --log<span class="o">=</span>/root/ks.post.log

<span class="c"># Allow User Interaction In The %post Section</span>
<span class="nb">exec</span> &lt; /dev/tty3 &gt; /dev/tty3
chvt 3

/bin/cat &gt; /root/Minimal.sh <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>

<span class="s"># Set Linux PATH Environment Variables</span>
<span class="s">PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin</span>
<span class="s">export PATH</span>
<span class="s">stty erase &#39;^?&#39;</span>

<span class="s"># Yum Update System</span>
<span class="s">\/bin/cp -Rf /boot/grub/grub.conf /boot/grub/grub.conf.bak</span>
<span class="s">/bin/sed -i &#39;/^.*exclude=.*/d&#39; /etc/yum.conf</span>
<span class="s">/usr/bin/yum update -y</span>

<span class="s"># Remove Unused Old Kernel</span>
<span class="s">/usr/bin/yum remove -y kernel-`/bin/uname -r`</span>

<span class="s"># Yum Clean Cache</span>
<span class="s">/usr/bin/yum clean all</span>
<span class="s">/bin/rm -rf /var/cache/yum/*</span>

<span class="s"># Prevent Future Yum Update Kernel</span>
<span class="s">/bin/echo &quot;exclude=kernel-2.* kernel-debug-2.*&quot; &gt;&gt; /etc/yum.conf</span>

<span class="s"># Remove Unnecessary Services on Boot</span>
<span class="s">/sbin/chkconfig iscsi off</span>
<span class="s">/sbin/chkconfig iscsid off</span>
<span class="s">/sbin/chkconfig lvm2-monitor off</span>
<span class="s">/sbin/chkconfig mcstrans off</span>
<span class="s">/sbin/chkconfig netfs off</span>
<span class="s">/sbin/chkconfig rawdevices off</span>

<span class="s"># Change Default SSH Port</span>
<span class="s">function change_sshport() {</span>
<span class="s">    /bin/echo -e &quot;\033[32m &gt;&gt;&gt; Configuring: Changing SSH Port ... \033[0m&quot;</span>
<span class="s">    # Take User Input</span>
<span class="s">    /bin/echo -n -e &quot;\033[36m Enter New SSH Port \033[0m&quot;</span>
<span class="s">    read -t 30 -p &quot;(Default: 22): &quot; SSHPORT</span>
<span class="s">    /bin/echo &quot;&quot;</span>
<span class="s">    if [[ &quot;\$SSHPORT&quot; = &quot;&quot; ]] ; then</span>
<span class="s">        SSHPORT=&quot;22&quot;</span>
<span class="s">    fi</span>
<span class="s">    # Change Default SSH Port in OpenSSH</span>
<span class="s">    \/bin/cp -Rf /etc/ssh/sshd_config /etc/ssh/sshd_config.bak</span>
<span class="s">    /bin/sed -i &quot;s/^.*Port .*$\|^Port$/Port \$SSHPORT/g&quot; /etc/ssh/sshd_config</span>
<span class="s">    # Restart OpenSSH Daemon</span>
<span class="s">    sshd_restart</span>
<span class="s">}</span>

<span class="s"># Restart OpenSSH Daemon</span>
<span class="s">function sshd_restart() {</span>
<span class="s">    if [ -f /etc/rc.d/init.d/sshd ]; then</span>
<span class="s">        /etc/rc.d/init.d/sshd restart</span>
<span class="s">    else</span>
<span class="s">        /sbin/chkconfig sshd on</span>
<span class="s">        /sbin/service sshd restart</span>
<span class="s">    fi</span>
<span class="s">}</span>

<span class="s"># Remove Unneeded Getty Instances</span>
<span class="s">/bin/sed -e &#39;s/\(^[2-6].*getty.*\)/#\1/&#39; -i /etc/inittab</span>

<span class="s"># Disable SeLinux</span>
<span class="s">if [ -s /etc/selinux/config ]; then</span>
<span class="s">    setenforce 0</span>
<span class="s">    sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/config</span>
<span class="s">fi</span>

<span class="s"># Ask If Default SSH Port 22 Should Be Changed</span>
<span class="s">if /bin/egrep -q &quot;(^.*Port .*22.*$)&quot; /etc/ssh/sshd_config; then</span>
<span class="s">    /bin/echo -e &quot;\033[31m Detected sshd_config: Port 22, It&#39;s Dangerous and Should Be Changed! \033[0m&quot;</span>
<span class="s">    change_sshport</span>
<span class="s">fi</span>

<span class="s">/bin/rm -rf \$0</span>
<span class="s">exit 0</span>
<span class="s">EOF</span>

<span class="c"># Run Minimal.sh</span>
/bin/chmod +x /root/Minimal.sh
/bin/bash /root/Minimal.sh

chvt 3
</code>33[32m &gt;&gt;&gt; Configuring: Changing SSH Port ... <code class="bash"><span class="c"># CentOS 5.x Minimal Install Scripts</span>
<span class="c"># boot: linux ks=http://fzrxefe.googlecode.com/files/centos.58.x86.v1.5.ks.cfg</span>
<span class="c"># root&#39;s password: LazyZhu, Run &quot;passwd&quot; to Change it.</span>

<span class="c"># Basic Configuration</span>
install
lang en_US.UTF-8
keyboard us
timezone --utc Asia/Shanghai
rootpw --iscrypted <span class="nv">$1$M6UtZ5TA$K9BDnMbbXnXLK8qpVOf</span>/i0
<span class="c"># Display Configuration</span>
text
skipx
<span class="c"># Authentication</span>
authconfig --enableshadow --enablemd5
<span class="c"># Installation Method</span>
url --url http://mirrors.usc.edu/pub/linux/distributions/centos/5/os/i386
logging --level<span class="o">=</span>info
reboot
<span class="c"># Boot Loader Options</span>
bootloader --location<span class="o">=</span>mbr
<span class="c"># Partition Information</span>
zerombr
clearpart --all --initlabel
part swap --fstype swap --size<span class="o">=</span>512
part / --fstype ext3 --size<span class="o">=</span>100 --grow
<span class="c"># Network Configuration</span>
network --onboot yes --device eth0 --bootproto dhcp --noipv6 --hostname Minimal
<span class="c"># Firewall Configuration</span>
selinux --disabled
firewall --disabled
<span class="c"># Package Selection</span>
%packages --nobase --ignoremissing
audit-libs
basesystem
bash
binutils
bzip2
bzip2-libs
centos-release
centos-release-notes
chkconfig
coreutils
cpio
cracklib
cracklib-dicts
crontabs
cyrus-sasl-lib
db4
device-mapper
device-mapper-event
device-mapper-multipath
dhclient
diffutils
dmraid
dmraid-events
e2fsprogs
e2fsprogs-libs
elfutils-libelf
ethtool
expat
filesystem
findutils
fipscheck
fipscheck-lib
gawk
gdbm
glib2
glibc
glibc-common
grep
grub
gzip
hmaccalc
info
initscripts
iproute
iputils
iscsi-initiator-utils
kbd
kernel
keyutils-libs
kpartx
krb5-libs
less
libacl
libattr
libcap
libgcc
libselinux
libsepol
libstdc++
libsysfs
libtermcap
libuser
libutempter
libxml2
logrotate
lvm2
m2crypto
MAKEDEV
mcstrans
mingetty
mkinitrd
mktemp
module-init-tools
nano
nash
ncurses
net-tools
nspr
nss
openldap
openssh
openssh-clients
openssh-server
openssl
pam
passwd
pcre
popt
procps
psmisc
python
python-elementtree
python-iniparse
python-libs
python-sqlite
python-urlgrabber
readline
redhat-logos
rootfiles
rpm
rpm-libs
rpm-python
sed
setup
sgpio
shadow-utils
sqlite
sysklogd
SysVinit
tar
tcp_wrappers
termcap
tzdata
udev
usermode
util-linux
vim-minimal
vixie-cron
wget
which
yum
yum-fastestmirror
yum-metadata-parser
zlib
-atk
-audit-libs-python
-authconfig
-binutils
-bitstream-vera-fonts
-cairo
-checkpolicy
-cryptsetup-luks
-cups-libs
-dbus
-dbus-glib
-dbus-libs
-dhcpv6-client
-dmidecode
-ecryptfs-utils
-ed
-file
-fontconfig
-freetype
-gnu-efi
-gnutls
-gtk2
-hal
-hdparm
-hicolor-icon-theme
-hwdata
-keyutils
-kudzu
-libgcrypt
-libgpg-error
-libhugetlbfs
-libjpeg
-libpng
-libselinux-python
-libselinux-utils
-libsemanage
-libtiff
-libusb
-libvolume_id
-libX11
-libXau
-libXcursor
-libXdmcp
-libXext
-libXfixes
-libXft
-libXi
-libXinerama
-libXrandr
-libXrender
-newt
-pango
-pciutils
-pm-utils
-policycoreutils
-prelink
-rsyslog
-selinux-policy
-selinux-policy-targeted
-setools
-setserial
-slang
-sysfsutils
-tcl
-trousers
-udftools
-xorg-x11-filesystem

<span class="c"># Pre-installation Script</span>

<span class="c"># Post-installation Script</span>
%post --log<span class="o">=</span>/root/ks.post.log

<span class="c"># Allow User Interaction In The %post Section</span>
<span class="nb">exec</span> &lt; /dev/tty3 &gt; /dev/tty3
chvt 3

/bin/cat &gt; /root/Minimal.sh <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>

<span class="s"># Set Linux PATH Environment Variables</span>
<span class="s">PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin</span>
<span class="s">export PATH</span>
<span class="s">stty erase &#39;^?&#39;</span>

<span class="s"># Yum Update System</span>
<span class="s">\/bin/cp -Rf /boot/grub/grub.conf /boot/grub/grub.conf.bak</span>
<span class="s">/bin/sed -i &#39;/^.*exclude=.*/d&#39; /etc/yum.conf</span>
<span class="s">/usr/bin/yum update -y</span>

<span class="s"># Remove Unused Old Kernel</span>
<span class="s">/usr/bin/yum remove -y kernel-`/bin/uname -r`</span>

<span class="s"># Yum Clean Cache</span>
<span class="s">/usr/bin/yum clean all</span>
<span class="s">/bin/rm -rf /var/cache/yum/*</span>

<span class="s"># Prevent Future Yum Update Kernel</span>
<span class="s">/bin/echo &quot;exclude=kernel-2.* kernel-debug-2.*&quot; &gt;&gt; /etc/yum.conf</span>

<span class="s"># Remove Unnecessary Services on Boot</span>
<span class="s">/sbin/chkconfig iscsi off</span>
<span class="s">/sbin/chkconfig iscsid off</span>
<span class="s">/sbin/chkconfig lvm2-monitor off</span>
<span class="s">/sbin/chkconfig mcstrans off</span>
<span class="s">/sbin/chkconfig netfs off</span>
<span class="s">/sbin/chkconfig rawdevices off</span>

<span class="s"># Change Default SSH Port</span>
<span class="s">function change_sshport() {</span>
<span class="s">    /bin/echo -e &quot;\033[32m &gt;&gt;&gt; Configuring: Changing SSH Port ... \033[0m&quot;</span>
<span class="s">    # Take User Input</span>
<span class="s">    /bin/echo -n -e &quot;\033[36m Enter New SSH Port \033[0m&quot;</span>
<span class="s">    read -t 30 -p &quot;(Default: 22): &quot; SSHPORT</span>
<span class="s">    /bin/echo &quot;&quot;</span>
<span class="s">    if [[ &quot;\$SSHPORT&quot; = &quot;&quot; ]] ; then</span>
<span class="s">        SSHPORT=&quot;22&quot;</span>
<span class="s">    fi</span>
<span class="s">    # Change Default SSH Port in OpenSSH</span>
<span class="s">    \/bin/cp -Rf /etc/ssh/sshd_config /etc/ssh/sshd_config.bak</span>
<span class="s">    /bin/sed -i &quot;s/^.*Port .*$\|^Port$/Port \$SSHPORT/g&quot; /etc/ssh/sshd_config</span>
<span class="s">    # Restart OpenSSH Daemon</span>
<span class="s">    sshd_restart</span>
<span class="s">}</span>

<span class="s"># Restart OpenSSH Daemon</span>
<span class="s">function sshd_restart() {</span>
<span class="s">    if [ -f /etc/rc.d/init.d/sshd ]; then</span>
<span class="s">        /etc/rc.d/init.d/sshd restart</span>
<span class="s">    else</span>
<span class="s">        /sbin/chkconfig sshd on</span>
<span class="s">        /sbin/service sshd restart</span>
<span class="s">    fi</span>
<span class="s">}</span>

<span class="s"># Remove Unneeded Getty Instances</span>
<span class="s">/bin/sed -e &#39;s/\(^[2-6].*getty.*\)/#\1/&#39; -i /etc/inittab</span>

<span class="s"># Disable SeLinux</span>
<span class="s">if [ -s /etc/selinux/config ]; then</span>
<span class="s">    setenforce 0</span>
<span class="s">    sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/config</span>
<span class="s">fi</span>

<span class="s"># Ask If Default SSH Port 22 Should Be Changed</span>
<span class="s">if /bin/egrep -q &quot;(^.*Port .*22.*$)&quot; /etc/ssh/sshd_config; then</span>
<span class="s">    /bin/echo -e &quot;\033[31m Detected sshd_config: Port 22, It&#39;s Dangerous and Should Be Changed! \033[0m&quot;</span>
<span class="s">    change_sshport</span>
<span class="s">fi</span>

<span class="s">/bin/rm -rf \$0</span>
<span class="s">exit 0</span>
<span class="s">EOF</span>

<span class="c"># Run Minimal.sh</span>
/bin/chmod +x /root/Minimal.sh
/bin/bash /root/Minimal.sh

chvt 3
</code>33[0m"</span>
<span class="s">    # Take User Input</span>
<span class="s">    /bin/echo -n -e "<code class="bash"><span class="c"># CentOS 5.x Minimal Install Scripts</span>
<span class="c"># boot: linux ks=http://fzrxefe.googlecode.com/files/centos.58.x86.v1.5.ks.cfg</span>
<span class="c"># root&#39;s password: LazyZhu, Run &quot;passwd&quot; to Change it.</span>

<span class="c"># Basic Configuration</span>
install
lang en_US.UTF-8
keyboard us
timezone --utc Asia/Shanghai
rootpw --iscrypted <span class="nv">$1$M6UtZ5TA$K9BDnMbbXnXLK8qpVOf</span>/i0
<span class="c"># Display Configuration</span>
text
skipx
<span class="c"># Authentication</span>
authconfig --enableshadow --enablemd5
<span class="c"># Installation Method</span>
url --url http://mirrors.usc.edu/pub/linux/distributions/centos/5/os/i386
logging --level<span class="o">=</span>info
reboot
<span class="c"># Boot Loader Options</span>
bootloader --location<span class="o">=</span>mbr
<span class="c"># Partition Information</span>
zerombr
clearpart --all --initlabel
part swap --fstype swap --size<span class="o">=</span>512
part / --fstype ext3 --size<span class="o">=</span>100 --grow
<span class="c"># Network Configuration</span>
network --onboot yes --device eth0 --bootproto dhcp --noipv6 --hostname Minimal
<span class="c"># Firewall Configuration</span>
selinux --disabled
firewall --disabled
<span class="c"># Package Selection</span>
%packages --nobase --ignoremissing
audit-libs
basesystem
bash
binutils
bzip2
bzip2-libs
centos-release
centos-release-notes
chkconfig
coreutils
cpio
cracklib
cracklib-dicts
crontabs
cyrus-sasl-lib
db4
device-mapper
device-mapper-event
device-mapper-multipath
dhclient
diffutils
dmraid
dmraid-events
e2fsprogs
e2fsprogs-libs
elfutils-libelf
ethtool
expat
filesystem
findutils
fipscheck
fipscheck-lib
gawk
gdbm
glib2
glibc
glibc-common
grep
grub
gzip
hmaccalc
info
initscripts
iproute
iputils
iscsi-initiator-utils
kbd
kernel
keyutils-libs
kpartx
krb5-libs
less
libacl
libattr
libcap
libgcc
libselinux
libsepol
libstdc++
libsysfs
libtermcap
libuser
libutempter
libxml2
logrotate
lvm2
m2crypto
MAKEDEV
mcstrans
mingetty
mkinitrd
mktemp
module-init-tools
nano
nash
ncurses
net-tools
nspr
nss
openldap
openssh
openssh-clients
openssh-server
openssl
pam
passwd
pcre
popt
procps
psmisc
python
python-elementtree
python-iniparse
python-libs
python-sqlite
python-urlgrabber
readline
redhat-logos
rootfiles
rpm
rpm-libs
rpm-python
sed
setup
sgpio
shadow-utils
sqlite
sysklogd
SysVinit
tar
tcp_wrappers
termcap
tzdata
udev
usermode
util-linux
vim-minimal
vixie-cron
wget
which
yum
yum-fastestmirror
yum-metadata-parser
zlib
-atk
-audit-libs-python
-authconfig
-binutils
-bitstream-vera-fonts
-cairo
-checkpolicy
-cryptsetup-luks
-cups-libs
-dbus
-dbus-glib
-dbus-libs
-dhcpv6-client
-dmidecode
-ecryptfs-utils
-ed
-file
-fontconfig
-freetype
-gnu-efi
-gnutls
-gtk2
-hal
-hdparm
-hicolor-icon-theme
-hwdata
-keyutils
-kudzu
-libgcrypt
-libgpg-error
-libhugetlbfs
-libjpeg
-libpng
-libselinux-python
-libselinux-utils
-libsemanage
-libtiff
-libusb
-libvolume_id
-libX11
-libXau
-libXcursor
-libXdmcp
-libXext
-libXfixes
-libXft
-libXi
-libXinerama
-libXrandr
-libXrender
-newt
-pango
-pciutils
-pm-utils
-policycoreutils
-prelink
-rsyslog
-selinux-policy
-selinux-policy-targeted
-setools
-setserial
-slang
-sysfsutils
-tcl
-trousers
-udftools
-xorg-x11-filesystem

<span class="c"># Pre-installation Script</span>

<span class="c"># Post-installation Script</span>
%post --log<span class="o">=</span>/root/ks.post.log

<span class="c"># Allow User Interaction In The %post Section</span>
<span class="nb">exec</span> &lt; /dev/tty3 &gt; /dev/tty3
chvt 3

/bin/cat &gt; /root/Minimal.sh <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>

<span class="s"># Set Linux PATH Environment Variables</span>
<span class="s">PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin</span>
<span class="s">export PATH</span>
<span class="s">stty erase &#39;^?&#39;</span>

<span class="s"># Yum Update System</span>
<span class="s">\/bin/cp -Rf /boot/grub/grub.conf /boot/grub/grub.conf.bak</span>
<span class="s">/bin/sed -i &#39;/^.*exclude=.*/d&#39; /etc/yum.conf</span>
<span class="s">/usr/bin/yum update -y</span>

<span class="s"># Remove Unused Old Kernel</span>
<span class="s">/usr/bin/yum remove -y kernel-`/bin/uname -r`</span>

<span class="s"># Yum Clean Cache</span>
<span class="s">/usr/bin/yum clean all</span>
<span class="s">/bin/rm -rf /var/cache/yum/*</span>

<span class="s"># Prevent Future Yum Update Kernel</span>
<span class="s">/bin/echo &quot;exclude=kernel-2.* kernel-debug-2.*&quot; &gt;&gt; /etc/yum.conf</span>

<span class="s"># Remove Unnecessary Services on Boot</span>
<span class="s">/sbin/chkconfig iscsi off</span>
<span class="s">/sbin/chkconfig iscsid off</span>
<span class="s">/sbin/chkconfig lvm2-monitor off</span>
<span class="s">/sbin/chkconfig mcstrans off</span>
<span class="s">/sbin/chkconfig netfs off</span>
<span class="s">/sbin/chkconfig rawdevices off</span>

<span class="s"># Change Default SSH Port</span>
<span class="s">function change_sshport() {</span>
<span class="s">    /bin/echo -e &quot;\033[32m &gt;&gt;&gt; Configuring: Changing SSH Port ... \033[0m&quot;</span>
<span class="s">    # Take User Input</span>
<span class="s">    /bin/echo -n -e &quot;\033[36m Enter New SSH Port \033[0m&quot;</span>
<span class="s">    read -t 30 -p &quot;(Default: 22): &quot; SSHPORT</span>
<span class="s">    /bin/echo &quot;&quot;</span>
<span class="s">    if [[ &quot;\$SSHPORT&quot; = &quot;&quot; ]] ; then</span>
<span class="s">        SSHPORT=&quot;22&quot;</span>
<span class="s">    fi</span>
<span class="s">    # Change Default SSH Port in OpenSSH</span>
<span class="s">    \/bin/cp -Rf /etc/ssh/sshd_config /etc/ssh/sshd_config.bak</span>
<span class="s">    /bin/sed -i &quot;s/^.*Port .*$\|^Port$/Port \$SSHPORT/g&quot; /etc/ssh/sshd_config</span>
<span class="s">    # Restart OpenSSH Daemon</span>
<span class="s">    sshd_restart</span>
<span class="s">}</span>

<span class="s"># Restart OpenSSH Daemon</span>
<span class="s">function sshd_restart() {</span>
<span class="s">    if [ -f /etc/rc.d/init.d/sshd ]; then</span>
<span class="s">        /etc/rc.d/init.d/sshd restart</span>
<span class="s">    else</span>
<span class="s">        /sbin/chkconfig sshd on</span>
<span class="s">        /sbin/service sshd restart</span>
<span class="s">    fi</span>
<span class="s">}</span>

<span class="s"># Remove Unneeded Getty Instances</span>
<span class="s">/bin/sed -e &#39;s/\(^[2-6].*getty.*\)/#\1/&#39; -i /etc/inittab</span>

<span class="s"># Disable SeLinux</span>
<span class="s">if [ -s /etc/selinux/config ]; then</span>
<span class="s">    setenforce 0</span>
<span class="s">    sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/config</span>
<span class="s">fi</span>

<span class="s"># Ask If Default SSH Port 22 Should Be Changed</span>
<span class="s">if /bin/egrep -q &quot;(^.*Port .*22.*$)&quot; /etc/ssh/sshd_config; then</span>
<span class="s">    /bin/echo -e &quot;\033[31m Detected sshd_config: Port 22, It&#39;s Dangerous and Should Be Changed! \033[0m&quot;</span>
<span class="s">    change_sshport</span>
<span class="s">fi</span>

<span class="s">/bin/rm -rf \$0</span>
<span class="s">exit 0</span>
<span class="s">EOF</span>

<span class="c"># Run Minimal.sh</span>
/bin/chmod +x /root/Minimal.sh
/bin/bash /root/Minimal.sh

chvt 3
</code>33[36m Enter New SSH Port <code class="bash"><span class="c"># CentOS 5.x Minimal Install Scripts</span>
<span class="c"># boot: linux ks=http://fzrxefe.googlecode.com/files/centos.58.x86.v1.5.ks.cfg</span>
<span class="c"># root&#39;s password: LazyZhu, Run &quot;passwd&quot; to Change it.</span>

<span class="c"># Basic Configuration</span>
install
lang en_US.UTF-8
keyboard us
timezone --utc Asia/Shanghai
rootpw --iscrypted <span class="nv">$1$M6UtZ5TA$K9BDnMbbXnXLK8qpVOf</span>/i0
<span class="c"># Display Configuration</span>
text
skipx
<span class="c"># Authentication</span>
authconfig --enableshadow --enablemd5
<span class="c"># Installation Method</span>
url --url http://mirrors.usc.edu/pub/linux/distributions/centos/5/os/i386
logging --level<span class="o">=</span>info
reboot
<span class="c"># Boot Loader Options</span>
bootloader --location<span class="o">=</span>mbr
<span class="c"># Partition Information</span>
zerombr
clearpart --all --initlabel
part swap --fstype swap --size<span class="o">=</span>512
part / --fstype ext3 --size<span class="o">=</span>100 --grow
<span class="c"># Network Configuration</span>
network --onboot yes --device eth0 --bootproto dhcp --noipv6 --hostname Minimal
<span class="c"># Firewall Configuration</span>
selinux --disabled
firewall --disabled
<span class="c"># Package Selection</span>
%packages --nobase --ignoremissing
audit-libs
basesystem
bash
binutils
bzip2
bzip2-libs
centos-release
centos-release-notes
chkconfig
coreutils
cpio
cracklib
cracklib-dicts
crontabs
cyrus-sasl-lib
db4
device-mapper
device-mapper-event
device-mapper-multipath
dhclient
diffutils
dmraid
dmraid-events
e2fsprogs
e2fsprogs-libs
elfutils-libelf
ethtool
expat
filesystem
findutils
fipscheck
fipscheck-lib
gawk
gdbm
glib2
glibc
glibc-common
grep
grub
gzip
hmaccalc
info
initscripts
iproute
iputils
iscsi-initiator-utils
kbd
kernel
keyutils-libs
kpartx
krb5-libs
less
libacl
libattr
libcap
libgcc
libselinux
libsepol
libstdc++
libsysfs
libtermcap
libuser
libutempter
libxml2
logrotate
lvm2
m2crypto
MAKEDEV
mcstrans
mingetty
mkinitrd
mktemp
module-init-tools
nano
nash
ncurses
net-tools
nspr
nss
openldap
openssh
openssh-clients
openssh-server
openssl
pam
passwd
pcre
popt
procps
psmisc
python
python-elementtree
python-iniparse
python-libs
python-sqlite
python-urlgrabber
readline
redhat-logos
rootfiles
rpm
rpm-libs
rpm-python
sed
setup
sgpio
shadow-utils
sqlite
sysklogd
SysVinit
tar
tcp_wrappers
termcap
tzdata
udev
usermode
util-linux
vim-minimal
vixie-cron
wget
which
yum
yum-fastestmirror
yum-metadata-parser
zlib
-atk
-audit-libs-python
-authconfig
-binutils
-bitstream-vera-fonts
-cairo
-checkpolicy
-cryptsetup-luks
-cups-libs
-dbus
-dbus-glib
-dbus-libs
-dhcpv6-client
-dmidecode
-ecryptfs-utils
-ed
-file
-fontconfig
-freetype
-gnu-efi
-gnutls
-gtk2
-hal
-hdparm
-hicolor-icon-theme
-hwdata
-keyutils
-kudzu
-libgcrypt
-libgpg-error
-libhugetlbfs
-libjpeg
-libpng
-libselinux-python
-libselinux-utils
-libsemanage
-libtiff
-libusb
-libvolume_id
-libX11
-libXau
-libXcursor
-libXdmcp
-libXext
-libXfixes
-libXft
-libXi
-libXinerama
-libXrandr
-libXrender
-newt
-pango
-pciutils
-pm-utils
-policycoreutils
-prelink
-rsyslog
-selinux-policy
-selinux-policy-targeted
-setools
-setserial
-slang
-sysfsutils
-tcl
-trousers
-udftools
-xorg-x11-filesystem

<span class="c"># Pre-installation Script</span>

<span class="c"># Post-installation Script</span>
%post --log<span class="o">=</span>/root/ks.post.log

<span class="c"># Allow User Interaction In The %post Section</span>
<span class="nb">exec</span> &lt; /dev/tty3 &gt; /dev/tty3
chvt 3

/bin/cat &gt; /root/Minimal.sh <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>

<span class="s"># Set Linux PATH Environment Variables</span>
<span class="s">PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin</span>
<span class="s">export PATH</span>
<span class="s">stty erase &#39;^?&#39;</span>

<span class="s"># Yum Update System</span>
<span class="s">\/bin/cp -Rf /boot/grub/grub.conf /boot/grub/grub.conf.bak</span>
<span class="s">/bin/sed -i &#39;/^.*exclude=.*/d&#39; /etc/yum.conf</span>
<span class="s">/usr/bin/yum update -y</span>

<span class="s"># Remove Unused Old Kernel</span>
<span class="s">/usr/bin/yum remove -y kernel-`/bin/uname -r`</span>

<span class="s"># Yum Clean Cache</span>
<span class="s">/usr/bin/yum clean all</span>
<span class="s">/bin/rm -rf /var/cache/yum/*</span>

<span class="s"># Prevent Future Yum Update Kernel</span>
<span class="s">/bin/echo &quot;exclude=kernel-2.* kernel-debug-2.*&quot; &gt;&gt; /etc/yum.conf</span>

<span class="s"># Remove Unnecessary Services on Boot</span>
<span class="s">/sbin/chkconfig iscsi off</span>
<span class="s">/sbin/chkconfig iscsid off</span>
<span class="s">/sbin/chkconfig lvm2-monitor off</span>
<span class="s">/sbin/chkconfig mcstrans off</span>
<span class="s">/sbin/chkconfig netfs off</span>
<span class="s">/sbin/chkconfig rawdevices off</span>

<span class="s"># Change Default SSH Port</span>
<span class="s">function change_sshport() {</span>
<span class="s">    /bin/echo -e &quot;\033[32m &gt;&gt;&gt; Configuring: Changing SSH Port ... \033[0m&quot;</span>
<span class="s">    # Take User Input</span>
<span class="s">    /bin/echo -n -e &quot;\033[36m Enter New SSH Port \033[0m&quot;</span>
<span class="s">    read -t 30 -p &quot;(Default: 22): &quot; SSHPORT</span>
<span class="s">    /bin/echo &quot;&quot;</span>
<span class="s">    if [[ &quot;\$SSHPORT&quot; = &quot;&quot; ]] ; then</span>
<span class="s">        SSHPORT=&quot;22&quot;</span>
<span class="s">    fi</span>
<span class="s">    # Change Default SSH Port in OpenSSH</span>
<span class="s">    \/bin/cp -Rf /etc/ssh/sshd_config /etc/ssh/sshd_config.bak</span>
<span class="s">    /bin/sed -i &quot;s/^.*Port .*$\|^Port$/Port \$SSHPORT/g&quot; /etc/ssh/sshd_config</span>
<span class="s">    # Restart OpenSSH Daemon</span>
<span class="s">    sshd_restart</span>
<span class="s">}</span>

<span class="s"># Restart OpenSSH Daemon</span>
<span class="s">function sshd_restart() {</span>
<span class="s">    if [ -f /etc/rc.d/init.d/sshd ]; then</span>
<span class="s">        /etc/rc.d/init.d/sshd restart</span>
<span class="s">    else</span>
<span class="s">        /sbin/chkconfig sshd on</span>
<span class="s">        /sbin/service sshd restart</span>
<span class="s">    fi</span>
<span class="s">}</span>

<span class="s"># Remove Unneeded Getty Instances</span>
<span class="s">/bin/sed -e &#39;s/\(^[2-6].*getty.*\)/#\1/&#39; -i /etc/inittab</span>

<span class="s"># Disable SeLinux</span>
<span class="s">if [ -s /etc/selinux/config ]; then</span>
<span class="s">    setenforce 0</span>
<span class="s">    sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/config</span>
<span class="s">fi</span>

<span class="s"># Ask If Default SSH Port 22 Should Be Changed</span>
<span class="s">if /bin/egrep -q &quot;(^.*Port .*22.*$)&quot; /etc/ssh/sshd_config; then</span>
<span class="s">    /bin/echo -e &quot;\033[31m Detected sshd_config: Port 22, It&#39;s Dangerous and Should Be Changed! \033[0m&quot;</span>
<span class="s">    change_sshport</span>
<span class="s">fi</span>

<span class="s">/bin/rm -rf \$0</span>
<span class="s">exit 0</span>
<span class="s">EOF</span>

<span class="c"># Run Minimal.sh</span>
/bin/chmod +x /root/Minimal.sh
/bin/bash /root/Minimal.sh

chvt 3
</code>33[0m"</span>
<span class="s">    read -t 30 -p "(Default: 22): " SSHPORT</span>
<span class="s">    /bin/echo ""</span>
<span class="s">    if [[ "\$SSHPORT" = "" ]] ; then</span>
<span class="s">        SSHPORT="22"</span>
<span class="s">    fi</span>
<span class="s">    # Change Default SSH Port in OpenSSH</span>
<span class="s">    \/bin/cp -Rf /etc/ssh/sshd_config /etc/ssh/sshd_config.bak</span>
<span class="s">    /bin/sed -i "s/^.*Port .*$\|^Port$/Port \$SSHPORT/g" /etc/ssh/sshd_config</span>
<span class="s">    # Restart OpenSSH Daemon</span>
<span class="s">    sshd_restart</span>
<span class="s">}</span>
<span class="s"># Restart OpenSSH Daemon</span>
<span class="s">function sshd_restart() {</span>
<span class="s">    if [ -f /etc/rc.d/init.d/sshd ]; then</span>
<span class="s">        /etc/rc.d/init.d/sshd restart</span>
<span class="s">    else</span>
<span class="s">        /sbin/chkconfig sshd on</span>
<span class="s">        /sbin/service sshd restart</span>
<span class="s">    fi</span>
<span class="s">}</span>
<span class="s"># Remove Unneeded Getty Instances</span>
<span class="s">/bin/sed -e 's/\(^[2-6].*getty.*\)/#/' -i /etc/inittab</span>
<span class="s"># Disable SeLinux</span>
<span class="s">if [ -s /etc/selinux/config ]; then</span>
<span class="s">    setenforce 0</span>
<span class="s">    sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</span>
<span class="s">fi</span>
<span class="s"># Ask If Default SSH Port 22 Should Be Changed</span>
<span class="s">if /bin/egrep -q "(^.*Port .*22.*$)" /etc/ssh/sshd_config; then</span>
<span class="s">    /bin/echo -e "<code class="bash"><span class="c"># CentOS 5.x Minimal Install Scripts</span>
<span class="c"># boot: linux ks=http://fzrxefe.googlecode.com/files/centos.58.x86.v1.5.ks.cfg</span>
<span class="c"># root&#39;s password: LazyZhu, Run &quot;passwd&quot; to Change it.</span>

<span class="c"># Basic Configuration</span>
install
lang en_US.UTF-8
keyboard us
timezone --utc Asia/Shanghai
rootpw --iscrypted <span class="nv">$1$M6UtZ5TA$K9BDnMbbXnXLK8qpVOf</span>/i0
<span class="c"># Display Configuration</span>
text
skipx
<span class="c"># Authentication</span>
authconfig --enableshadow --enablemd5
<span class="c"># Installation Method</span>
url --url http://mirrors.usc.edu/pub/linux/distributions/centos/5/os/i386
logging --level<span class="o">=</span>info
reboot
<span class="c"># Boot Loader Options</span>
bootloader --location<span class="o">=</span>mbr
<span class="c"># Partition Information</span>
zerombr
clearpart --all --initlabel
part swap --fstype swap --size<span class="o">=</span>512
part / --fstype ext3 --size<span class="o">=</span>100 --grow
<span class="c"># Network Configuration</span>
network --onboot yes --device eth0 --bootproto dhcp --noipv6 --hostname Minimal
<span class="c"># Firewall Configuration</span>
selinux --disabled
firewall --disabled
<span class="c"># Package Selection</span>
%packages --nobase --ignoremissing
audit-libs
basesystem
bash
binutils
bzip2
bzip2-libs
centos-release
centos-release-notes
chkconfig
coreutils
cpio
cracklib
cracklib-dicts
crontabs
cyrus-sasl-lib
db4
device-mapper
device-mapper-event
device-mapper-multipath
dhclient
diffutils
dmraid
dmraid-events
e2fsprogs
e2fsprogs-libs
elfutils-libelf
ethtool
expat
filesystem
findutils
fipscheck
fipscheck-lib
gawk
gdbm
glib2
glibc
glibc-common
grep
grub
gzip
hmaccalc
info
initscripts
iproute
iputils
iscsi-initiator-utils
kbd
kernel
keyutils-libs
kpartx
krb5-libs
less
libacl
libattr
libcap
libgcc
libselinux
libsepol
libstdc++
libsysfs
libtermcap
libuser
libutempter
libxml2
logrotate
lvm2
m2crypto
MAKEDEV
mcstrans
mingetty
mkinitrd
mktemp
module-init-tools
nano
nash
ncurses
net-tools
nspr
nss
openldap
openssh
openssh-clients
openssh-server
openssl
pam
passwd
pcre
popt
procps
psmisc
python
python-elementtree
python-iniparse
python-libs
python-sqlite
python-urlgrabber
readline
redhat-logos
rootfiles
rpm
rpm-libs
rpm-python
sed
setup
sgpio
shadow-utils
sqlite
sysklogd
SysVinit
tar
tcp_wrappers
termcap
tzdata
udev
usermode
util-linux
vim-minimal
vixie-cron
wget
which
yum
yum-fastestmirror
yum-metadata-parser
zlib
-atk
-audit-libs-python
-authconfig
-binutils
-bitstream-vera-fonts
-cairo
-checkpolicy
-cryptsetup-luks
-cups-libs
-dbus
-dbus-glib
-dbus-libs
-dhcpv6-client
-dmidecode
-ecryptfs-utils
-ed
-file
-fontconfig
-freetype
-gnu-efi
-gnutls
-gtk2
-hal
-hdparm
-hicolor-icon-theme
-hwdata
-keyutils
-kudzu
-libgcrypt
-libgpg-error
-libhugetlbfs
-libjpeg
-libpng
-libselinux-python
-libselinux-utils
-libsemanage
-libtiff
-libusb
-libvolume_id
-libX11
-libXau
-libXcursor
-libXdmcp
-libXext
-libXfixes
-libXft
-libXi
-libXinerama
-libXrandr
-libXrender
-newt
-pango
-pciutils
-pm-utils
-policycoreutils
-prelink
-rsyslog
-selinux-policy
-selinux-policy-targeted
-setools
-setserial
-slang
-sysfsutils
-tcl
-trousers
-udftools
-xorg-x11-filesystem

<span class="c"># Pre-installation Script</span>

<span class="c"># Post-installation Script</span>
%post --log<span class="o">=</span>/root/ks.post.log

<span class="c"># Allow User Interaction In The %post Section</span>
<span class="nb">exec</span> &lt; /dev/tty3 &gt; /dev/tty3
chvt 3

/bin/cat &gt; /root/Minimal.sh <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>

<span class="s"># Set Linux PATH Environment Variables</span>
<span class="s">PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin</span>
<span class="s">export PATH</span>
<span class="s">stty erase &#39;^?&#39;</span>

<span class="s"># Yum Update System</span>
<span class="s">\/bin/cp -Rf /boot/grub/grub.conf /boot/grub/grub.conf.bak</span>
<span class="s">/bin/sed -i &#39;/^.*exclude=.*/d&#39; /etc/yum.conf</span>
<span class="s">/usr/bin/yum update -y</span>

<span class="s"># Remove Unused Old Kernel</span>
<span class="s">/usr/bin/yum remove -y kernel-`/bin/uname -r`</span>

<span class="s"># Yum Clean Cache</span>
<span class="s">/usr/bin/yum clean all</span>
<span class="s">/bin/rm -rf /var/cache/yum/*</span>

<span class="s"># Prevent Future Yum Update Kernel</span>
<span class="s">/bin/echo &quot;exclude=kernel-2.* kernel-debug-2.*&quot; &gt;&gt; /etc/yum.conf</span>

<span class="s"># Remove Unnecessary Services on Boot</span>
<span class="s">/sbin/chkconfig iscsi off</span>
<span class="s">/sbin/chkconfig iscsid off</span>
<span class="s">/sbin/chkconfig lvm2-monitor off</span>
<span class="s">/sbin/chkconfig mcstrans off</span>
<span class="s">/sbin/chkconfig netfs off</span>
<span class="s">/sbin/chkconfig rawdevices off</span>

<span class="s"># Change Default SSH Port</span>
<span class="s">function change_sshport() {</span>
<span class="s">    /bin/echo -e &quot;\033[32m &gt;&gt;&gt; Configuring: Changing SSH Port ... \033[0m&quot;</span>
<span class="s">    # Take User Input</span>
<span class="s">    /bin/echo -n -e &quot;\033[36m Enter New SSH Port \033[0m&quot;</span>
<span class="s">    read -t 30 -p &quot;(Default: 22): &quot; SSHPORT</span>
<span class="s">    /bin/echo &quot;&quot;</span>
<span class="s">    if [[ &quot;\$SSHPORT&quot; = &quot;&quot; ]] ; then</span>
<span class="s">        SSHPORT=&quot;22&quot;</span>
<span class="s">    fi</span>
<span class="s">    # Change Default SSH Port in OpenSSH</span>
<span class="s">    \/bin/cp -Rf /etc/ssh/sshd_config /etc/ssh/sshd_config.bak</span>
<span class="s">    /bin/sed -i &quot;s/^.*Port .*$\|^Port$/Port \$SSHPORT/g&quot; /etc/ssh/sshd_config</span>
<span class="s">    # Restart OpenSSH Daemon</span>
<span class="s">    sshd_restart</span>
<span class="s">}</span>

<span class="s"># Restart OpenSSH Daemon</span>
<span class="s">function sshd_restart() {</span>
<span class="s">    if [ -f /etc/rc.d/init.d/sshd ]; then</span>
<span class="s">        /etc/rc.d/init.d/sshd restart</span>
<span class="s">    else</span>
<span class="s">        /sbin/chkconfig sshd on</span>
<span class="s">        /sbin/service sshd restart</span>
<span class="s">    fi</span>
<span class="s">}</span>

<span class="s"># Remove Unneeded Getty Instances</span>
<span class="s">/bin/sed -e &#39;s/\(^[2-6].*getty.*\)/#\1/&#39; -i /etc/inittab</span>

<span class="s"># Disable SeLinux</span>
<span class="s">if [ -s /etc/selinux/config ]; then</span>
<span class="s">    setenforce 0</span>
<span class="s">    sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/config</span>
<span class="s">fi</span>

<span class="s"># Ask If Default SSH Port 22 Should Be Changed</span>
<span class="s">if /bin/egrep -q &quot;(^.*Port .*22.*$)&quot; /etc/ssh/sshd_config; then</span>
<span class="s">    /bin/echo -e &quot;\033[31m Detected sshd_config: Port 22, It&#39;s Dangerous and Should Be Changed! \033[0m&quot;</span>
<span class="s">    change_sshport</span>
<span class="s">fi</span>

<span class="s">/bin/rm -rf \$0</span>
<span class="s">exit 0</span>
<span class="s">EOF</span>

<span class="c"># Run Minimal.sh</span>
/bin/chmod +x /root/Minimal.sh
/bin/bash /root/Minimal.sh

chvt 3
</code>33[31m Detected sshd_config: Port 22, It's Dangerous and Should Be Changed! <code class="bash"><span class="c"># CentOS 5.x Minimal Install Scripts</span>
<span class="c"># boot: linux ks=http://fzrxefe.googlecode.com/files/centos.58.x86.v1.5.ks.cfg</span>
<span class="c"># root&#39;s password: LazyZhu, Run &quot;passwd&quot; to Change it.</span>

<span class="c"># Basic Configuration</span>
install
lang en_US.UTF-8
keyboard us
timezone --utc Asia/Shanghai
rootpw --iscrypted <span class="nv">$1$M6UtZ5TA$K9BDnMbbXnXLK8qpVOf</span>/i0
<span class="c"># Display Configuration</span>
text
skipx
<span class="c"># Authentication</span>
authconfig --enableshadow --enablemd5
<span class="c"># Installation Method</span>
url --url http://mirrors.usc.edu/pub/linux/distributions/centos/5/os/i386
logging --level<span class="o">=</span>info
reboot
<span class="c"># Boot Loader Options</span>
bootloader --location<span class="o">=</span>mbr
<span class="c"># Partition Information</span>
zerombr
clearpart --all --initlabel
part swap --fstype swap --size<span class="o">=</span>512
part / --fstype ext3 --size<span class="o">=</span>100 --grow
<span class="c"># Network Configuration</span>
network --onboot yes --device eth0 --bootproto dhcp --noipv6 --hostname Minimal
<span class="c"># Firewall Configuration</span>
selinux --disabled
firewall --disabled
<span class="c"># Package Selection</span>
%packages --nobase --ignoremissing
audit-libs
basesystem
bash
binutils
bzip2
bzip2-libs
centos-release
centos-release-notes
chkconfig
coreutils
cpio
cracklib
cracklib-dicts
crontabs
cyrus-sasl-lib
db4
device-mapper
device-mapper-event
device-mapper-multipath
dhclient
diffutils
dmraid
dmraid-events
e2fsprogs
e2fsprogs-libs
elfutils-libelf
ethtool
expat
filesystem
findutils
fipscheck
fipscheck-lib
gawk
gdbm
glib2
glibc
glibc-common
grep
grub
gzip
hmaccalc
info
initscripts
iproute
iputils
iscsi-initiator-utils
kbd
kernel
keyutils-libs
kpartx
krb5-libs
less
libacl
libattr
libcap
libgcc
libselinux
libsepol
libstdc++
libsysfs
libtermcap
libuser
libutempter
libxml2
logrotate
lvm2
m2crypto
MAKEDEV
mcstrans
mingetty
mkinitrd
mktemp
module-init-tools
nano
nash
ncurses
net-tools
nspr
nss
openldap
openssh
openssh-clients
openssh-server
openssl
pam
passwd
pcre
popt
procps
psmisc
python
python-elementtree
python-iniparse
python-libs
python-sqlite
python-urlgrabber
readline
redhat-logos
rootfiles
rpm
rpm-libs
rpm-python
sed
setup
sgpio
shadow-utils
sqlite
sysklogd
SysVinit
tar
tcp_wrappers
termcap
tzdata
udev
usermode
util-linux
vim-minimal
vixie-cron
wget
which
yum
yum-fastestmirror
yum-metadata-parser
zlib
-atk
-audit-libs-python
-authconfig
-binutils
-bitstream-vera-fonts
-cairo
-checkpolicy
-cryptsetup-luks
-cups-libs
-dbus
-dbus-glib
-dbus-libs
-dhcpv6-client
-dmidecode
-ecryptfs-utils
-ed
-file
-fontconfig
-freetype
-gnu-efi
-gnutls
-gtk2
-hal
-hdparm
-hicolor-icon-theme
-hwdata
-keyutils
-kudzu
-libgcrypt
-libgpg-error
-libhugetlbfs
-libjpeg
-libpng
-libselinux-python
-libselinux-utils
-libsemanage
-libtiff
-libusb
-libvolume_id
-libX11
-libXau
-libXcursor
-libXdmcp
-libXext
-libXfixes
-libXft
-libXi
-libXinerama
-libXrandr
-libXrender
-newt
-pango
-pciutils
-pm-utils
-policycoreutils
-prelink
-rsyslog
-selinux-policy
-selinux-policy-targeted
-setools
-setserial
-slang
-sysfsutils
-tcl
-trousers
-udftools
-xorg-x11-filesystem

<span class="c"># Pre-installation Script</span>

<span class="c"># Post-installation Script</span>
%post --log<span class="o">=</span>/root/ks.post.log

<span class="c"># Allow User Interaction In The %post Section</span>
<span class="nb">exec</span> &lt; /dev/tty3 &gt; /dev/tty3
chvt 3

/bin/cat &gt; /root/Minimal.sh <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>

<span class="s"># Set Linux PATH Environment Variables</span>
<span class="s">PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin</span>
<span class="s">export PATH</span>
<span class="s">stty erase &#39;^?&#39;</span>

<span class="s"># Yum Update System</span>
<span class="s">\/bin/cp -Rf /boot/grub/grub.conf /boot/grub/grub.conf.bak</span>
<span class="s">/bin/sed -i &#39;/^.*exclude=.*/d&#39; /etc/yum.conf</span>
<span class="s">/usr/bin/yum update -y</span>

<span class="s"># Remove Unused Old Kernel</span>
<span class="s">/usr/bin/yum remove -y kernel-`/bin/uname -r`</span>

<span class="s"># Yum Clean Cache</span>
<span class="s">/usr/bin/yum clean all</span>
<span class="s">/bin/rm -rf /var/cache/yum/*</span>

<span class="s"># Prevent Future Yum Update Kernel</span>
<span class="s">/bin/echo &quot;exclude=kernel-2.* kernel-debug-2.*&quot; &gt;&gt; /etc/yum.conf</span>

<span class="s"># Remove Unnecessary Services on Boot</span>
<span class="s">/sbin/chkconfig iscsi off</span>
<span class="s">/sbin/chkconfig iscsid off</span>
<span class="s">/sbin/chkconfig lvm2-monitor off</span>
<span class="s">/sbin/chkconfig mcstrans off</span>
<span class="s">/sbin/chkconfig netfs off</span>
<span class="s">/sbin/chkconfig rawdevices off</span>

<span class="s"># Change Default SSH Port</span>
<span class="s">function change_sshport() {</span>
<span class="s">    /bin/echo -e &quot;\033[32m &gt;&gt;&gt; Configuring: Changing SSH Port ... \033[0m&quot;</span>
<span class="s">    # Take User Input</span>
<span class="s">    /bin/echo -n -e &quot;\033[36m Enter New SSH Port \033[0m&quot;</span>
<span class="s">    read -t 30 -p &quot;(Default: 22): &quot; SSHPORT</span>
<span class="s">    /bin/echo &quot;&quot;</span>
<span class="s">    if [[ &quot;\$SSHPORT&quot; = &quot;&quot; ]] ; then</span>
<span class="s">        SSHPORT=&quot;22&quot;</span>
<span class="s">    fi</span>
<span class="s">    # Change Default SSH Port in OpenSSH</span>
<span class="s">    \/bin/cp -Rf /etc/ssh/sshd_config /etc/ssh/sshd_config.bak</span>
<span class="s">    /bin/sed -i &quot;s/^.*Port .*$\|^Port$/Port \$SSHPORT/g&quot; /etc/ssh/sshd_config</span>
<span class="s">    # Restart OpenSSH Daemon</span>
<span class="s">    sshd_restart</span>
<span class="s">}</span>

<span class="s"># Restart OpenSSH Daemon</span>
<span class="s">function sshd_restart() {</span>
<span class="s">    if [ -f /etc/rc.d/init.d/sshd ]; then</span>
<span class="s">        /etc/rc.d/init.d/sshd restart</span>
<span class="s">    else</span>
<span class="s">        /sbin/chkconfig sshd on</span>
<span class="s">        /sbin/service sshd restart</span>
<span class="s">    fi</span>
<span class="s">}</span>

<span class="s"># Remove Unneeded Getty Instances</span>
<span class="s">/bin/sed -e &#39;s/\(^[2-6].*getty.*\)/#\1/&#39; -i /etc/inittab</span>

<span class="s"># Disable SeLinux</span>
<span class="s">if [ -s /etc/selinux/config ]; then</span>
<span class="s">    setenforce 0</span>
<span class="s">    sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/config</span>
<span class="s">fi</span>

<span class="s"># Ask If Default SSH Port 22 Should Be Changed</span>
<span class="s">if /bin/egrep -q &quot;(^.*Port .*22.*$)&quot; /etc/ssh/sshd_config; then</span>
<span class="s">    /bin/echo -e &quot;\033[31m Detected sshd_config: Port 22, It&#39;s Dangerous and Should Be Changed! \033[0m&quot;</span>
<span class="s">    change_sshport</span>
<span class="s">fi</span>

<span class="s">/bin/rm -rf \$0</span>
<span class="s">exit 0</span>
<span class="s">EOF</span>

<span class="c"># Run Minimal.sh</span>
/bin/chmod +x /root/Minimal.sh
/bin/bash /root/Minimal.sh

chvt 3
</code>33[0m"</span>
<span class="s">    change_sshport</span>
<span class="s">fi</span>
<span class="s">/bin/rm -rf \$0</span>
<span class="s">exit 0</span>
<span class="s">EOF</span>
<span class="c"># Run Minimal.sh</span>
/bin/chmod +x /root/Minimal.sh
/bin/bash /root/Minimal.sh
chvt 3
</code></pre></div><br/><h2>可能感兴趣的文章：</h2><ul><li><a href="/Linux/Setup-server-ssh-keys-and-safe-login-for-authentication.html">配置并使用SSH密匙对自动登录服务器</a></li><li><a href="/Nginx/How-to-use-nginx-GzipStatic-module-to-reduce-resource-usage.html">巧用Nginx的GzipStatic模块来减少服务器资源占用</a></li><li><a href="/Linux/Multiple-ways-to-generate-ssh-public-and-private-keys.html">SSH密匙对生成方法汇总</a></li></ul><div class="ds-thread" data-thread-key="" data-title="" data-author-key="" data-url=""></div> <script>var duoshuoQuery={short_name:"lazyzhu"};(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://static.duoshuo.com/embed.js",e.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script></div></div><div class="footer"> © 2012 <a href="/about.html">LazyZhu</a> All Rights Reserved. Powered by <a rel="Hostshare" href="http://my.hostshare.cn/cart.php">Hostshare</a> & <a rel="Github" href="http://pages.github.com">Github</a>.</div></body> <!--[if !IE]><!--> <script src="/assets/js/main.js"></script><!--<![endif]--></html>