<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>巧用Nginx的GzipStatic模块来减少服务器资源占用</title><meta name="author" content="LazyZhu"/><meta name="keywords" content="nginx,gzip,static,shell,script"/><meta name="description" content="这里介绍了Nginx的GzipStatic模块的原理及安装使用方法，还编写了Shell脚本减少维护工作量。"/><link rel="stylesheet" type="text/css" href="/assets/css/main.css"/><link rel="stylesheet" type="text/css" href="/assets/css/pygments.css"/></head><body><div class="container"><div class="header"><div id="siteName"> L<u>azy</u>Z<u>hu's</u> H<u>ome</u> <b><font color="red">★The Diaoyu Islands belong to China!★</font></b></div><ul class="menu main"><li class="menu_item"> <a href="/">Home</a></li><li class="menu_item"> <a href="/projects.html">Projects</a></li><li class="menu_item"> <a href="/wiki.html">Wiki</a></li><li class="menu_item"> <a href="/about.html">About</a></li></ul></div><div class="sidebar"><div><center><form id="cse" id="searchbox_005189583365303993202:tnnrmg1lhbi" action="/SearchResults.html"> <input value="005189583365303993202:dwmyxdrq_ny" name="cx" type="hidden"/> <input value="FORID:11" name="cof" type="hidden"/> <input id="q" style="width:110px" name="q" size="75" /> <input value="Search" name="sa" type="submit"/></form></center><h4>分类</h4><ul><li> <a href="/categories.html#Linux"> Linux </a> <sup>[3]</sup></li><li> <a href="/categories.html#Nginx"> <b><font color="blue">Nginx</font></b> </a> <sup>[3]</sup></li><li> <a href="/categories.html#Life"> Life </a> <sup>[1]</sup></li></ul><hr/><h4>标签</h4><ul><li> <a href="/tags.html#script"> <b><font color="blue">script</font></b> </a> <sup>[2]</sup></li><li> <a href="/tags.html#compile"> compile </a> <sup>[2]</sup></li><li> <a href="/tags.html#xshell"> xshell </a> <sup>[2]</sup></li><li> <a href="/tags.html#publickey"> publickey </a> <sup>[1]</sup></li><li> <a href="/tags.html#linux"> linux </a> <sup>[3]</sup></li><li> <a href="/tags.html#blog"> blog </a> <sup>[1]</sup></li><li> <a href="/tags.html#module"> module </a> <sup>[2]</sup></li><li> <a href="/tags.html#centos"> centos </a> <sup>[1]</sup></li><li> <a href="/tags.html#windows"> windows </a> <sup>[1]</sup></li><li> <a href="/tags.html#nginx"> <b><font color="blue">nginx</font></b> </a> <sup>[3]</sup></li><li> <a href="/tags.html#memcached"> memcached </a> <sup>[1]</sup></li><li> <a href="/tags.html#static"> <b><font color="blue">static</font></b> </a> <sup>[1]</sup></li><li> <a href="/tags.html#shell"> <b><font color="blue">shell</font></b> </a> <sup>[1]</sup></li><li> <a href="/tags.html#ssh"> ssh </a> <sup>[1]</sup></li><li> <a href="/tags.html#gzip"> <b><font color="blue">gzip</font></b> </a> <sup>[1]</sup></li><li> <a href="/tags.html#redis"> redis </a> <sup>[1]</sup></li><li> <a href="/tags.html#lnmp"> lnmp </a> <sup>[2]</sup></li><li> <a href="/tags.html#automate"> automate </a> <sup>[2]</sup></li><li> <a href="/tags.html#putty"> putty </a> <sup>[2]</sup></li><li> <a href="/tags.html#kickstart"> kickstart </a> <sup>[1]</sup></li><li> <a href="/tags.html#life"> life </a> <sup>[1]</sup></li></ul><hr/><h4>归档</h4><ul><li><b><font color="blue"><a href="/archive.html#2012">2012</a></font></b></li></ul></div></div><div class="content"><div class="tags"> 分类: /<a class="category" href="/categories.html#Nginx">Nginx</a>/ - 标签: <span class="tag"><a href="/tags.html#nginx">nginx</a></span> <span class="tag"><a href="/tags.html#gzip">gzip</a></span> <span class="tag"><a href="/tags.html#static">static</a></span> <span class="tag"><a href="/tags.html#shell">shell</a></span> <span class="tag"><a href="/tags.html#script">script</a></span> - 日期: 2012.09.02</div><br/><h1>巧用Nginx的GzipStatic模块来减少服务器资源占用</h1><p>Nginx的<a href="http://wiki.nginx.org/HttpGzipModule" title="HttpGzipModule">Gzip模块</a>在加速网页加载上效果很明显，一般服务器都会在前端启用；但是Nginx还有另一个与Gzip有关的模块-<a href="http://wiki.nginx.org/HttpGzipStaticModule" title="HttpGzipStaticModule">GzipStatic模块</a>，下面将详细讲解下该模块。</p><br/><h2>1. 原理</h2><p>先了解下Nginx的Gzip模块,其作用就是在服务器上把网页的内容压缩后传给客户端，客户端解压后再显示网页的内容，这样就减少了网络传输的数据量，鉴于目前网络带宽相对较小、而电脑的处理能力普遍强大的情况，将明显提升网页的加载速度，优化访客体验，所以建议在条件允许的情况下都开启这个。</p><p>开启Gzip模块增加了服务器端和客户端的工作量，在服务器开启Gzip以及客户端没有Cache的情况下，客户端的每次请求都会使服务器压缩一次，这样就浪费了大量CPU，除非服务器前端加了反向代理缓存。</p><p>GzipStatic模块就是为了解决这一问题而被开发出来的。它又叫Gzip Pre-Compression Module，这个模块的作用是对于需要压缩的文件，直接读取已经压缩好的文件，而不是每次都压缩。但有个缺陷就是必须预先手动将静态文件压缩为同名文件的.gz格式，文章最后有一小脚本可以帮你解决这一问题。</p><br/><h2>2. 安装</h2><p>如果是通过 <code>yum</code> 或 <code>apt-get</code> 安装的Nginx，默认就包含了GzipStatic模块，你不用做任何修改；如果是通过源码编译，则需添加编译参数</p><div class="highlight"><pre><code class="bash">--with-http_gzip_static_module
</code></pre></div><p>LNMP一键包默认安装了GzipStatic模块，你不用做任何修改。</p><br/><h2>3. 启用</h2><p>只需在Nginx配置文件 <code>nginx.conf</code> 的 <code>http</code> 区块中添加</p><div class="highlight"><pre><code class="bash">gzip_static on;
</code></pre></div><p>LNMP一键包默认启用了GzipStatic模块，你也不用做任何修改。</p><br/><h2>4. 脚本</h2><p>写了个 Bash Shell 小脚本，可以遍历指定目录下的 <code>css</code> 、<code>js</code> 和 <code>html</code> 后缀文件并自动生成同名gz压缩文件。</p><p>脚本使用方法：将脚本另存为 <code>pre-gzip.sh</code>，并运行：</p><div class="highlight"><pre><code class="bash"><span class="c"># /home/lazyzhu.com/ 为网站目录，需改为你自己的。</span>
pre-gzip.sh /home/lazyzhu.com/
</code></pre></div><p>脚本如下：</p><div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="nv">PATH</span><span class="o">=</span>/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
<span class="nb">export </span>PATH
<span class="nv">ScriptName</span><span class="o">=</span><span class="k">${</span><span class="nv">0</span><span class="p">##*/</span><span class="k">}</span>
<span class="k">function </span>print_usage<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"Please Use $ScriptName &lt;directory&gt;."</span>
<span class="o">}</span>
<span class="c">## Check the number of arguments.</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-ne 1 <span class="o">]</span>; <span class="k">then</span>
print_usage
    <span class="nb">exit </span>1
<span class="k">fi</span>
<span class="c">## $1 - the static file directory.</span>
<span class="k">function </span>gzip_static_files<span class="o">()</span> <span class="o">{</span>
    <span class="nv">filelist</span><span class="o">=</span><span class="sb">`</span>find <span class="nv">$1</span> -maxdepth 88 <span class="se">\(</span> -name <span class="s2">"*.css"</span> -o -name <span class="s2">"*.js"</span> -o -name <span class="s2">"*.html"</span> <span class="se">\)</span> -type f<span class="sb">`</span>
    <span class="k">for </span>file in <span class="nv">$filelist</span>
    <span class="k">do</span>
<span class="k">        </span>gzip -5 -f -c <span class="nv">$file</span> &gt; <span class="nv">$file</span>.gz
    <span class="k">done</span>
<span class="o">}</span>
<span class="c"># gzip_static_files</span>
gzip_static_files <span class="nv">$1</span>
<span class="nb">exit </span>0
</code></pre></div><br/><h2>可能感兴趣的文章：</h2><ul><li><a href="/Nginx/LNMP-compile-nginx-redis-module-to-build-redis-cache.html">LNMP编译安装Redis构建高速Redis缓存</a></li><li><a href="/Nginx/LNMP-compile-memc-and-srcache-nginx-module-with-memcached.html">LNMP编译Memc和Srcache构建高速Memcached缓存</a></li><li><a href="/Linux/Automated-and-quick-install-centos-5-with-kickstart.html">使用Kickstart全自动化安装CentOS 5.x系统</a></li></ul><div class="ds-thread" data-thread-key="" data-title="" data-author-key="" data-url=""></div> <script>var duoshuoQuery={short_name:"lazyzhu"};(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://static.duoshuo.com/embed.js",e.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script></div></div><div class="footer"> © 2012 <a href="/about.html">LazyZhu</a> All Rights Reserved. Powered by <a rel="Hostshare" href="http://my.hostshare.cn/cart.php">Hostshare</a> & <a rel="Github" href="http://pages.github.com">Github</a>.</div></body> <!--[if !IE]><!--> <script src="/assets/js/main.js"></script><!--<![endif]--></html>